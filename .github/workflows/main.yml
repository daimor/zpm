name: CI
on: 
  push:
    branches: [master]
jobs:
  build:
    strategy:
      matrix:
        image: [
          "store/intersystems/iris-community:2019.4.0.383.0",
          "store/intersystems/irishealth-community:2019.4.0.383.0",
          "store/intersystems/iris-community:2020.1.0.215.0",
          "store/intersystems/irishealth-community:2020.1.0.215.0"
        ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Build
        run: docker build --rm --build-arg BASE=${{ matrix.image }} -t zpm .
      - name: Run temporary registry
        run: |
            docker pull docker.pkg.github.com/intersystems-community/zpm-registry/zpm-registry
            mkdir -p /tmp/registry/
            echo password > /tmp/registry/password.txt
            docker run --init --rm -d \
              --network zpm \
              -v /tmp/registry:/home/irisowner/registry \
              docker.pkg.github.com/intersystems-community/zpm-registry/zpm-registry \
              -p /home/irisowner/registry/password.txt
            REGISTRY=`docker ps -lq`
            while [ "`docker container inspect -f {{.State.Health.Status}} $REGISTRY`" != "healthy" ]; do echo Waiting container; sleep 1; done
      - name: Test and publish to temporary registry
        timeout-minutes: 15
        run: |
            CONTAINER=`docker run --network zpm -d --rm --init zpm`
            docker ps
            docker logs $CONTAINER
            while [ "`docker container inspect -f {{.State.Health.Status}} $CONTAINER`" != "healthy" ]; do echo Waiting container; sleep 1; done
            /bin/echo -e '' \
              'zpm "list":1\n' \
              'zpm "zpm test":1\n' \
              'zpm "repo -r -name registry -url https://pm.community.intersystems.com/":1\n' \
              'zpm "repo -list":1\n' \
              'zpm "install dsw":1\n' \
              'zpm "list":1\n' \
              'zpm "repo -r -name registry -url http://registry:52773/registry/":1\n' \
              'zn "%sys"' \
              'zpm "publish zpm -v":1' \
              'halt\n' \
            | docker exec -i $CONTAINER iris session iris -U%SYS
            docker stop $CONTAINER
      - name: Stop temporary registry
        run: docker stop $REGISTRY
